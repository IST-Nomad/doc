
# Настройки
$days = 90
$time = (Get-Date).AddDays(-$days)
$exportPath = "C:\Scripts\StaleComputers.csv"

# Поиск устаревших компьютеров
$computers = Get-ADComputer -Filter {LastLogonDate -lt $time -and Enabled -eq $true} -Properties LastLogonDate |
    Select-Object Name, LastLogonDate, DistinguishedName

# Экспорт в CSV
$computers | Export-Csv -Path $exportPath -NoTypeInformation -Encoding UTF8

# Параметры SMTP
$smtpServer = "smtp.yourdomain.local"
$from = "report@yourdomain.local"
$to = "admin@yourdomain.local"
$subject = "Отчет: Устаревшие учетные записи компьютеров"
$body = "Во вложении список компьютеров, не входивших в домен более $days дней."

# Отправка письма
Send-MailMessage -From $from -To $to -Subject $subject -Body $body -SmtpServer $smtpServer -Attachments $exportPath



Active Directory: утилита DCDIAG

Утилита dcdiag позволяет выполнить до 20 тестов над инфраструктурой Active Directory. Некоторые из тестов предоставляют диагностическую информацию об определенном контроллере домена. Многие тесты предоставляют информацию о конфигурации репликации в пределах леса.

Advertising
Проверяет, правильно ли контроллер домена сообщает о себе и о своей роли хозяина операций. Этот тест завершиться неудачно, если служба NetLogon не запущена

CheckSDRefDom
Проверяет правильность доменов ссылок дескрипторов безопасности для каждого раздела каталогов программ

Connectivity
Проверяет регистрацию DNS для каждого контроллера домена, отправляет тестовый эхо-пакет на каждый контроллер домена и проверяет подключение по протоколам LDAP и RPC к каждому контроллеру домена

CrossRefValidation
Проверяет правильность перекрестных ссылок для доменов

RRSSysvol
проверяет состояние готовности для FRS SYSVOL

FRSEvent
Проверяет ошибки репликации в работе службы репликации файлов, что может означать наличие проблем в репликации SYSVOL и, таким образом, целостности копий объектов групповых политик

FSMOCheck
Не проверяет роли хозяев операций, а вместо этого запрашивает сервер глобального каталога, первичный контроллер домена, предпочтительный сервер времени, сервер времени и центр распространения ключей

Intersite
Проверяет наличие ошибок, которые могут помешать нормальной репликации между сайтами. Компания Microsoft предупреждает, что иногда результаты этого теста могут оказаться неточными

KCCEvent
Проверяет безошибочность создания объектов соединений для репликации между сайтами

KnowsOfRoleHolders
Проверяет возможность подключения контроллеров домена ко всем пяти хозяевам операций

MachineAccount
Проверяет правильность регистрации учетной записи целевого компьютера и правильность объявлений служб этого компьютера. Если обнаружена ошибка, ее можно исправить с помощью утилиты dcdiag, указав параметры /fixmachineaccount или /recreatemachineaccount

NCSecDesc
Проверяет правильность разрешений для репликации в дескрипторах безопасности для заголовков контекста именования

NetLogons
Проверяет правильность разрешений регистрации, позволяющих регистрацию, для каждого контроллера домена

ObjectsReplicated
Проверяет правильность репликации агента сервера каталогов и объектов учетных записей компьютеров

OutboundSecureChannels
Проверяется наличие безопасных каналов между всеми контроллерами домена в интересующем домене

Replications
Проверяет возможность репликации между контроллерами домена и сообщает обо всех ошибках при репликации

RidManager
Проверяет работоспособность и доступность хозяина относительных идентификаторов

Services
Проверяет работоспособность всех служб, необходимых для работы контроллера домена, на указанном контроллере домена

SystemLog
Проверяет безошибочность работы системного журнала

VerifyEnterpriseReferences
Проверяет действительность системных ссылок службы репликации файлов для всех объектов на всех контроллерах домена в лесу

VerifyReferences
Проверяет действительность системных ссылок службы репликации файлов для всех объектов на указанном контроллере домена

VerifyReplicas
Проверяет действительность всех разделов каталога приложения на всех серверах, принимающих участие в репликации

Синтаксис команды dcdiag:
dcdiag /s:<DomainController> [/n:<NamingContext>] [[/u:<domain\user>] [/p:<password>] ] [{/a|/e}{/q|/v}] [/i] [/f:<LogFile>] [/ferr:<ErrorLog>] [/c [/skip:<test]] [/test:<test>] [/fix]