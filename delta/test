==================================================
НАЧАЛО ВОССТАНОВЛЕНИЯ БАЗЫ
==================================================
Восстанавливаем GEstBank_Krona в GEstBank_Krona_pre
Подключено к серверу FINIST-PRE
Анализируем структуру файлов бэкапа:
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_CdsDB_0.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_ContractsDepositsAccounts_1.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_Operations_2.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_Audit_3.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_ChargeIntervals_4.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_ChargeOperationIntervals_5.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_ContractsDepositsAccounts_6.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_Data_7.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_DataIndexes_8.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_DocumentImages_9.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_History_10.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_HistoryIndexes_11.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_Inclusions_12.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_Indexes_13.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_CalendarEvents_14.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_ChargeIntervals_15.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_ContractsDepositsAccounts1_16.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_Operations1_17.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_Primary2_18.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_PrimaryN_19.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_SynTransactions_20.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_IX_Transactions_21.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_Operations_22.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_Transactions_23.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_WorkflowData_24.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_WorkflowIndexes_25.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_FileStorage_26.ndf
    -> будет перемещен в: C:\MSSQL16.MSSQLSERVER_PRE\MSSQL\DATA\GEstBank_Krona_pre_CdsDB_log_27.ldf
Удаляем существующую базу данных GEstBank_Krona_pre...
Старая база данных удалена (если существовала)
Начало восстановления базы GEstBank_Krona_pre...
Выполняем восстановление...
Восстановление завершено успешно
Проверяем состояние базы данных...
Состояние базы GEstBank_Krona_pre: RESTORING
Соединение с сервером закрыто
✓ Процесс завершен успешно!
Проверяем наличие скрипта: GEstBank_Krona_pre.sql
Найден скрипт: GEstBank_Krona_pre.sql
Выполняем SQL скрипт после восстановления...
Ошибка при выполнении пост-восстановительного скрипта: (18456, b"Login failed for user 'finistuser'.DB-Lib error message 20018, severity 14:\nGeneral SQL Server error: Check messages from the SQL Server\nDB-Lib error message 20002, severity 9:\nAdaptive Server connection failed (FINIST-PRE)\nDB-Lib error message 20002, severity 9:\nAdaptive Server connection failed (FINIST-PRE)\n")




def restore_database():
    global selected_server, username, password, backup_path_server2, backup_path_server3, database_name, target_db_name, restore_prefix, backup_name

    target_db_name = f"{database_name}{restore_prefix}"
    full_backup_path = os.path.join(backup_path_server2, backup_name) if restore_prefix == "_day" else os.path.join(backup_path_server2, backup_name) if restore_prefix == "_pre" else os.path.join(backup_path_server3, backup_name)

    print(f"Восстанавливаем {database_name} в {target_db_name}", flush=True)

    conn = None
    cursor = None

    try:
        # Создание строки подключения
        conn_str = (
            f"DRIVER={{ODBC Driver 17 for SQL Server}};"
            f"SERVER={selected_server};"
            f"DATABASE=master;"
        )

        if username and password:
            conn_str += f"UID={username};PWD={password}"

        # Подключение к серверу
        conn = pyodbc.connect(conn_str)
        cursor = conn.cursor()
        conn.autocommit = True

        print(f"Подключено к серверу {selected_server}")

        # Получение подробной информации о файлах из бэкапа
        cursor.execute("RESTORE FILELISTONLY FROM DISK = ?", (full_backup_path,))
        files_info = cursor.fetchall()

        if not files_info:
            print("Не удалось получить информацию о файлах из бэкапа")
            return False

        # Анализируем структуру файлов
        print("Анализируем структуру файлов бэкапа:")
        # Альтернативный вариант - используем временные уникальные пути для всех файлов
        move_commands = []

        for i, file_info in enumerate(files_info):
            logical_name = file_info[0]  # LogicalName
            file_type = file_info[2]  # Type (D - data, L - log)
            if restore_prefix == '_pre':
                target_path = f"C:\\MSSQL16.MSSQLSERVER_PRE\\MSSQL"
            elif restore_prefix == '_day':
                target_path = f"C:\\MSSQL16.MSSQLSERVER_PRE\\MSSQL"
            else:
                target_path = f"C:\\MSSQL\\MSSQL16.MSSQLSERVER\\MSSQL"
            # Создаем абсолютно уникальные пути для каждого файла
            if file_type == 'D':  # Data file
                new_physical_name = f"{target_path}\\DATA\\{target_db_name}_{logical_name}_{i}.ndf"
            elif file_type == 'L':  # Log file
                new_physical_name = f"{target_path}\\DATA\\{target_db_name}_{logical_name}_{i}.ldf"
            else:
                new_physical_name = f"{target_path}\\DATA\\{target_db_name}_{logical_name}_{i}.dat"

            move_commands.append(f"MOVE N'{logical_name}' TO N'{new_physical_name}'")
            print(f"    -> будет перемещен в: {new_physical_name}")

        # Удаление существующей базы данных (если есть)
        print(f"Удаляем существующую базу данных {target_db_name}...")
        try:
            kill_connections_sql = f"""
            IF EXISTS (SELECT name FROM sys.databases WHERE name = '{target_db_name}')
            BEGIN
                DECLARE @kill_connections NVARCHAR(MAX) = ''
                SELECT @kill_connections = @kill_connections + 'KILL ' + CAST(session_id AS NVARCHAR(10)) + ';'
                FROM sys.dm_exec_sessions
                WHERE database_id = DB_ID('{target_db_name}')

                IF @kill_connections <> ''
                    EXEC sp_executesql @kill_connections

                ALTER DATABASE [{target_db_name}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE
                DROP DATABASE [{target_db_name}]
            END
            """
            cursor.execute(kill_connections_sql)
            print("Старая база данных удалена (если существовала)")
        except pyodbc.Error as e:
            print(f"Предупреждение при удалении базы данных: {e}")

        print(f"Начало восстановления базы {target_db_name}...")

        # Формируем команду восстановления со всеми MOVE командами
        move_clause = ",\n    ".join(move_commands)
        restore_sql = f"""
        RESTORE DATABASE [{target_db_name}]
        FROM DISK = ?
        WITH 
            {move_clause},
            NOUNLOAD,
            REPLACE,
            RECOVERY,
            STATS = 5
        """

        print("Выполняем восстановление...")
        cursor.execute(restore_sql, (full_backup_path,))

        # Ждем завершения восстановления
        import time
        time.sleep(10)

        print("Восстановление завершено успешно")

        cursor.execute(f"ALTER DATABASE [{target_db_name}] SET ONLINE")

        # Проверяем состояние базы данных
        print("Проверяем состояние базы данных...")
        try:
            check_state_sql = f"""
            SELECT name, state_desc 
            FROM sys.databases 
            WHERE name = '{target_db_name}'
            """
            cursor.execute(check_state_sql)
            db_info = cursor.fetchone()

            if db_info:
                print(f"Состояние базы {db_info[0]}: {db_info[1]}")
            else:
                print("База данных не найдена после восстановления")
                return False

        except pyodbc.Error as e:
            print(f"Ошибка при проверке состояния: {e}")

        return True

    except pyodbc.Error as err:
        print(f"Ошибка при восстановлении базы данных: {err}")
        return False
    except Exception as e:
        print(f"Общая ошибка при восстановлении: {e}")
        return False
    finally:
        # Всегда закрываем соединение
        try:
            if cursor:
                cursor.close()
            if conn:
                conn.close()
                print("Соединение с сервером закрыто")
        except Exception as e:
            print(f"Ошибка при закрытии соединения: {e}")
